<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0a0015">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>KATZ LIFE</title>
    
    <!-- jsPDF Library for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a28;
            --accent-gold: #d4af37;
            --accent-purple: #a78bfa;
            --accent-pink: #f472b6;
            --accent-blue: #60a5fa;
            --text-primary: #ffffff;
            --text-secondary: #a0a0b8;
            --text-tertiary: #6b6b80;
            --glass-bg: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(212, 175, 55, 0.15);
            --shadow-gold: 0 8px 32px rgba(212, 175, 55, 0.2);
            --shadow-purple: 0 8px 32px rgba(167, 139, 250, 0.2);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0a0a0f 0%, #12121a 50%, #1a1a28 100%);
            color: var(--text-primary);
            overflow-x: hidden;
            min-height: 100vh;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 20%, rgba(212, 175, 55, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(167, 139, 250, 0.08) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        /* Particle Background */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: var(--accent-gold);
            border-radius: 50%;
            opacity: 0;
            animation: float 8s infinite ease-in-out;
        }

        @keyframes float {
            0%, 100% { 
                opacity: 0;
                transform: translateY(0) scale(0.5);
            }
            50% { 
                opacity: 0.6;
                transform: translateY(-100vh) scale(1);
            }
        }

        /* Onboarding */
        .onboarding {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a0a0f, #12121a);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 2rem 1.5rem;
            opacity: 1;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .onboarding.hidden {
            opacity: 0;
            transform: scale(0.9);
            pointer-events: none;
        }

        .logo {
            font-size: 2.5rem;
            font-weight: 900;
            letter-spacing: 8px;
            background: linear-gradient(135deg, var(--accent-gold) 0%, var(--accent-purple) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .tagline {
            font-size: 0.875rem;
            color: var(--text-tertiary);
            letter-spacing: 3px;
            margin-bottom: 4rem;
            text-transform: uppercase;
        }

        .onboarding-form {
            width: 100%;
            max-width: 420px;
        }

        .form-group {
            margin-bottom: 2rem;
        }

        .label {
            display: block;
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--accent-gold);
            margin-bottom: 0.875rem;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .input {
            width: 100%;
            padding: 1.25rem 1.5rem;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 400;
            backdrop-filter: blur(20px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .input:focus {
            outline: none;
            border-color: var(--accent-gold);
            background: rgba(212, 175, 55, 0.05);
            box-shadow: 0 0 0 4px rgba(212, 175, 55, 0.1);
        }

        .input::placeholder {
            color: var(--text-tertiary);
        }

        /* Custom Date Picker */
        .date-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .date-selector {
            position: relative;
        }

        .date-btn {
            width: 100%;
            padding: 1.25rem 1rem;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            backdrop-filter: blur(20px);
        }

        .date-btn:hover,
        .date-btn.active {
            border-color: var(--accent-gold);
            color: var(--text-primary);
            background: rgba(212, 175, 55, 0.05);
        }

        .date-dropdown {
            position: absolute;
            top: calc(100% + 0.75rem);
            left: 0;
            right: 0;
            background: var(--bg-tertiary);
            border: 1px solid var(--accent-gold);
            border-radius: 16px;
            max-height: 280px;
            overflow-y: auto;
            z-index: 1000;
            opacity: 0;
            transform: translateY(-10px) scale(0.95);
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-gold);
        }

        .date-dropdown.show {
            opacity: 1;
            transform: translateY(0) scale(1);
            pointer-events: all;
        }

        .date-option {
            padding: 1rem;
            text-align: center;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .date-option:hover {
            background: rgba(212, 175, 55, 0.1);
            color: var(--text-primary);
        }

        .date-dropdown::-webkit-scrollbar {
            width: 6px;
        }

        .date-dropdown::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }

        .date-dropdown::-webkit-scrollbar-thumb {
            background: var(--accent-gold);
            border-radius: 10px;
        }

        /* Life Expectancy Slider */
        .slider-wrapper {
            padding: 1.5rem 0;
        }

        .slider-display {
            text-align: center;
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1.5rem;
            letter-spacing: -1px;
        }

        .slider-track {
            position: relative;
            height: 8px;
            background: var(--glass-bg);
            border-radius: 10px;
            margin-bottom: 1rem;
        }

        .slider-fill {
            position: absolute;
            height: 100%;
            background: linear-gradient(90deg, var(--accent-gold), var(--accent-purple));
            border-radius: 10px;
            transition: width 0.2s ease;
        }

        .slider-input {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            top: 0;
            left: 0;
        }

        .slider-thumb {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-purple));
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.5);
            pointer-events: none;
            transition: transform 0.2s ease;
        }

        .slider-input:active + .slider-fill + .slider-thumb {
            transform: translate(-50%, -50%) scale(1.3);
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-tertiary);
            font-weight: 600;
        }

        /* Primary Button */
        .btn-primary {
            width: 100%;
            padding: 1.5rem;
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-purple));
            border: none;
            border-radius: 20px;
            color: var(--bg-primary);
            font-size: 1rem;
            font-weight: 800;
            cursor: pointer;
            letter-spacing: 2px;
            text-transform: uppercase;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-gold);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 48px rgba(212, 175, 55, 0.4);
        }

        .btn-primary:active {
            transform: translateY(-1px);
        }

        /* Main App */
        .app {
            position: relative;
            z-index: 2;
            padding-bottom: 100px;
            min-height: 100vh;
        }

        .app.hidden {
            display: none;
        }

        /* Views */
        .view {
            display: none;
            padding: 2rem 1rem;
            animation: viewFade 0.5s ease;
        }

        .view.active {
            display: block;
        }

        @keyframes viewFade {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Home View */
        .hero {
            text-align: center;
            padding: 3rem 0;
        }

        .hero-title {
            font-size: 0.875rem;
            font-weight: 700;
            color: var(--text-tertiary);
            letter-spacing: 3px;
            margin-bottom: 1.5rem;
            text-transform: uppercase;
        }

        .counter-display {
            font-size: 3.5rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--accent-gold) 0%, var(--accent-purple) 50%, var(--accent-pink) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1.1;
            margin-bottom: 0.75rem;
            letter-spacing: -2px;
        }

        .counter-label {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        /* Classic Widget Grid */
        .widget-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.25rem;
            margin-top: 3rem;
        }

        .widget {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 2rem 1.5rem;
            backdrop-filter: blur(30px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .widget::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(212, 175, 55, 0) 0%, rgba(212, 175, 55, 0.05) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .widget:hover::before {
            opacity: 1;
        }

        .widget:hover {
            border-color: var(--accent-gold);
            transform: translateY(-8px);
            box-shadow: var(--shadow-gold);
        }

        .widget-value {
            font-size: 2.25rem;
            font-weight: 900;
            color: var(--accent-gold);
            margin-bottom: 0.75rem;
            letter-spacing: -1px;
        }

        .widget-label {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            letter-spacing: 1px;
            text-transform: uppercase;
            font-weight: 600;
        }

        /* Content Cards */
        .card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 28px;
            padding: 2rem 1.25rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(30px);
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 2rem;
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }

        .textarea {
            width: 100%;
            min-height: 180px;
            padding: 1.5rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            color: var(--text-primary);
            font-size: 1rem;
            line-height: 1.7;
            resize: vertical;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        .textarea:focus {
            outline: none;
            border-color: var(--accent-gold);
            background: rgba(212, 175, 55, 0.05);
            box-shadow: 0 0 0 4px rgba(212, 175, 55, 0.1);
        }

        .textarea::placeholder {
            color: var(--text-tertiary);
        }

        /* Buttons */
        .btn-group {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .btn {
            flex: 1;
            padding: 1.25rem;
            border: none;
            border-radius: 18px;
            font-size: 0.875rem;
            font-weight: 700;
            cursor: pointer;
            letter-spacing: 1px;
            text-transform: uppercase;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-action {
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-purple));
            color: var(--bg-primary);
            box-shadow: var(--shadow-gold);
        }

        .btn-action:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 40px rgba(212, 175, 55, 0.4);
        }

        .btn-secondary {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-secondary);
        }

        .btn-secondary:hover {
            border-color: var(--accent-gold);
            color: var(--text-primary);
            background: rgba(212, 175, 55, 0.05);
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 4rem 0;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            width: 56px;
            height: 56px;
            border: 4px solid var(--glass-border);
            border-top: 4px solid var(--accent-gold);
            border-radius: 50%;
            animation: spin 1.2s linear infinite;
            margin: 0 auto 1.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 0.875rem;
            color: var(--text-tertiary);
            letter-spacing: 1px;
        }

        /* AI Output - IMPROVED FOR MOBILE */
        .output {
            display: none;
            margin-top: 2.5rem;
            padding: 0;
            background: transparent;
            border: none;
            max-height: 70vh;
            overflow-y: auto;
            overflow-x: hidden;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .output.show {
            display: block;
            animation: viewFade 0.6s ease;
        }

        /* AI Response Bubble - WIDER AND PREMIUM */
        .ai-response-bubble {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid var(--accent-gold);
            border-radius: 24px;
            padding: 2rem 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-gold);
            backdrop-filter: blur(20px);
            font-family: 'Crimson Pro', 'Georgia', serif;
            line-height: 1.9;
            font-size: 1.0625rem;
            color: var(--text-primary);
            width: 100%;
            max-width: 100%;
            word-wrap: break-word;
        }

        .output h2 {
            font-family: 'Inter', sans-serif;
            font-size: 1.75rem;
            font-weight: 800;
            color: var(--accent-gold);
            margin-bottom: 1.5rem;
            letter-spacing: -0.5px;
        }

        .output h3 {
            font-family: 'Inter', sans-serif;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--accent-purple);
            margin-top: 2.5rem;
            margin-bottom: 1.25rem;
        }

        .output p {
            margin-bottom: 1.5rem;
            color: var(--text-primary);
        }

        .output strong {
            color: var(--accent-pink);
            font-weight: 600;
        }

        /* KEY MOMENTS HIGHLIGHT */
        .key-moment {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.15), rgba(167, 139, 250, 0.15));
            border-left: 4px solid var(--accent-gold);
            padding: 1.25rem 1.5rem;
            margin: 1.5rem 0;
            border-radius: 12px;
            font-weight: 500;
        }

        .key-moment::before {
            content: '‚≠ê KEY MOMENT';
            display: block;
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--accent-gold);
            letter-spacing: 1px;
            margin-bottom: 0.75rem;
        }

        /* Custom scrollbar for output */
        .output::-webkit-scrollbar {
            width: 6px;
        }

        .output::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        .output::-webkit-scrollbar-thumb {
            background: var(--accent-gold);
            border-radius: 10px;
        }

        /* Profile */
        .profile-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .avatar-container {
            position: relative;
            width: 140px;
            height: 140px;
            margin: 0 auto 2rem;
        }

        .avatar {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-purple));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3.5rem;
            font-weight: 900;
            color: var(--bg-primary);
            box-shadow: var(--shadow-gold);
            position: relative;
            overflow: hidden;
        }

        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-upload-btn {
            position: absolute;
            bottom: 5px;
            right: 5px;
            width: 44px;
            height: 44px;
            background: var(--accent-gold);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.25rem;
            box-shadow: 0 4px 16px rgba(212, 175, 55, 0.6);
            transition: all 0.3s ease;
        }

        .avatar-upload-btn:hover {
            transform: scale(1.15);
            background: var(--accent-purple);
        }

        .avatar-upload-btn input {
            display: none;
        }

        .profile-name {
            font-size: 2rem;
            font-weight: 900;
            margin-bottom: 0.5rem;
            letter-spacing: -0.5px;
        }

        .profile-age {
            font-size: 1.125rem;
            color: var(--text-tertiary);
            margin-bottom: 1.5rem;
        }

        .level-badge {
            display: inline-block;
            padding: 0.75rem 2rem;
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-purple));
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 800;
            color: var(--bg-primary);
            letter-spacing: 1px;
            box-shadow: var(--shadow-gold);
        }

        /* EXP Bar */
        .exp-container {
            margin: 2.5rem 0;
        }

        .exp-bar {
            height: 12px;
            background: var(--glass-bg);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 0.75rem;
            position: relative;
        }

        .exp-progress {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-gold), var(--accent-purple));
            border-radius: 12px;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.6);
        }

        .exp-text {
            text-align: center;
            font-size: 0.875rem;
            color: var(--text-tertiary);
            font-weight: 600;
            letter-spacing: 1px;
        }

        /* Achievements */
        .achievement-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.25rem;
        }

        .achievement {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 1.75rem 1rem;
            text-align: center;
            transition: all 0.3s ease;
            opacity: 0.35;
        }

        .achievement.unlocked {
            opacity: 1;
            border-color: var(--accent-gold);
            box-shadow: var(--shadow-gold);
        }

        .achievement:hover {
            transform: translateY(-5px);
        }

        .achievement-icon {
            font-size: 2.5rem;
            margin-bottom: 0.75rem;
        }

        .achievement-name {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .achievement.unlocked .achievement-name {
            color: var(--accent-gold);
        }

        /* Files Section */
        .files-section {
            margin-top: 2rem;
        }

        .file-item {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            transition: all 0.3s ease;
        }

        .file-item:hover {
            border-color: var(--accent-gold);
            transform: translateY(-2px);
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-size: 0.9375rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
            word-wrap: break-word;
        }

        .file-date {
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        .file-actions {
            display: flex;
            gap: 0.75rem;
            width: 100%;
        }

        .file-btn {
            flex: 1;
            padding: 0.75rem 1rem;
            background: var(--glass-bg);
            border: 1px solid var(--accent-gold);
            border-radius: 12px;
            color: var(--accent-gold);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-btn:hover {
            background: rgba(212, 175, 55, 0.1);
            transform: translateY(-2px);
        }

        /* Professional Bottom Dock */
        .dock {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(10, 10, 15, 0.95);
            backdrop-filter: blur(40px);
            border-top: 1px solid var(--glass-border);
            padding: 0.5rem 1rem calc(env(safe-area-inset-bottom) + 0.5rem);
            z-index: 9999;
            box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.4);
        }

        .dock-items {
            display: flex;
            justify-content: space-around;
            align-items: center;
            max-width: 600px;
            margin: 0 auto;
        }

        .dock-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.375rem;
            padding: 0.75rem 0.5rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 16px;
            position: relative;
        }

        .dock-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 32px;
            height: 3px;
            background: var(--accent-gold);
            border-radius: 0 0 3px 3px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .dock-item.active::before {
            opacity: 1;
        }

        .dock-item:active {
            transform: scale(0.95);
        }

        .dock-icon {
            font-size: 1.75rem;
            transition: all 0.3s ease;
            filter: grayscale(1);
        }

        .dock-item.active .dock-icon {
            filter: grayscale(0);
            transform: scale(1.1);
        }

        .dock-label {
            font-size: 0.625rem;
            color: var(--text-tertiary);
            letter-spacing: 0.5px;
            text-transform: uppercase;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .dock-item.active .dock-label {
            color: var(--accent-gold);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 99999;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(20px);
            padding: 2rem;
        }

        .modal-overlay.show {
            opacity: 1;
            pointer-events: all;
        }

        .modal {
            background: var(--bg-tertiary);
            border: 1px solid var(--accent-gold);
            border-radius: 28px;
            padding: 2.5rem;
            max-width: 440px;
            width: 100%;
            transform: scale(0.85);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-gold);
        }

        .modal-overlay.show .modal {
            transform: scale(1);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 1.25rem;
            color: var(--accent-gold);
            letter-spacing: -0.5px;
        }

        .modal-message {
            font-size: 1rem;
            color: var(--text-secondary);
            line-height: 1.7;
            margin-bottom: 2rem;
        }

        .modal-btn {
            width: 100%;
            padding: 1.25rem;
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-purple));
            border: none;
            border-radius: 18px;
            color: var(--bg-primary);
            font-weight: 800;
            cursor: pointer;
            letter-spacing: 1px;
            text-transform: uppercase;
            transition: all 0.3s ease;
        }

        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-gold);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--glass-bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent-gold);
            border-radius: 10px;
        }

        /* Responsive */
        @media (max-width: 640px) {
            .counter-display {
                font-size: 2.75rem;
            }

            .widget-grid {
                gap: 1rem;
            }

            .widget {
                padding: 1.5rem 1rem;
            }

            .widget-value {
                font-size: 1.75rem;
            }

            .achievement-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .ai-response-bubble {
                padding: 1.5rem 1.25rem;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="particles" id="particles"></div>

    <!-- Onboarding -->
    <div class="onboarding" id="onboarding">
        <div class="logo">KATZ LIFE</div>
        <div class="tagline">Every Second Matters</div>

        <form class="onboarding-form" id="onboardingForm">
            <div class="form-group">
                <label class="label">Your Name</label>
                <input type="text" class="input" id="nameInput" placeholder="Enter your name" required>
            </div>

            <div class="form-group">
                <label class="label">Date of Birth</label>
                <div class="date-grid">
                    <div class="date-selector">
                        <button type="button" class="date-btn" id="dayBtn">Day</button>
                        <div class="date-dropdown" id="dayDropdown"></div>
                    </div>
                    <div class="date-selector">
                        <button type="button" class="date-btn" id="monthBtn">Month</button>
                        <div class="date-dropdown" id="monthDropdown"></div>
                    </div>
                    <div class="date-selector">
                        <button type="button" class="date-btn" id="yearBtn">Year</button>
                        <div class="date-dropdown" id="yearDropdown"></div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="label">Your Location</label>
                <input type="text" class="input" id="locationInput" placeholder="City, Country" required>
            </div>

            <div class="form-group">
                <label class="label">Life Expectancy</label>
                <div class="slider-wrapper">
                    <div class="slider-display" id="sliderValue">80 YEARS</div>
                    <div class="slider-track">
                        <input type="range" class="slider-input" id="lifeSlider" min="1" max="120" value="80">
                        <div class="slider-fill" id="sliderFill"></div>
                        <div class="slider-thumb" id="sliderThumb"></div>
                    </div>
                    <div class="slider-labels">
                        <span>1</span>
                        <span>120</span>
                    </div>
                </div>
            </div>

            <button type="submit" class="btn-primary">Begin Journey</button>
        </form>
    </div>

    <!-- Main App -->
    <div class="app hidden" id="app">
        <!-- Home View -->
        <div class="view active" id="homeView">
            <div class="hero">
                <div class="hero-title">Seconds Remaining</div>
                <div class="counter-display" id="secondsCounter">0</div>
                <div class="counter-label">Make them count</div>
            </div>

            <div class="widget-grid">
                <div class="widget">
                    <div class="widget-value" id="weeksLived">0</div>
                    <div class="widget-label">Weeks Lived</div>
                </div>
                <div class="widget">
                    <div class="widget-value" id="fullMoons">0</div>
                    <div class="widget-label">Full Moons</div>
                </div>
                <div class="widget">
                    <div class="widget-value" id="newYears">0</div>
                    <div class="widget-label">New Years</div>
                </div>
                <div class="widget">
                    <div class="widget-value" id="ageDisplay">0y 0m</div>
                    <div class="widget-label">Current Age</div>
                </div>
            </div>
        </div>

        <!-- Future View -->
        <div class="view" id="futureView">
            <div class="card">
                <h2 class="card-title">Craft Your Future</h2>
                <textarea class="textarea" id="futureInput" placeholder="Describe your dreams, aspirations, and vision for your future... Be as detailed as you want. What do you want to achieve? Who do you want to become? What legacy do you want to leave?"></textarea>
                <div class="btn-group">
                    <button class="btn btn-action" id="generateFutureBtn">Generate Story</button>
                </div>
                <div class="loading" id="futureLoading">
                    <div class="spinner"></div>
                    <div class="loading-text">Crafting your future...</div>
                </div>
                <div class="output" id="futureOutput"></div>
                <div class="btn-group" id="futureActions" style="display: none;">
                    <button class="btn btn-secondary" id="shareFuture">Share</button>
                    <button class="btn btn-secondary" id="exportFuture">Download PDF</button>
                </div>
            </div>
        </div>

        <!-- Movie View -->
        <div class="view" id="movieView">
            <div class="card">
                <h2 class="card-title">Your Life as Cinema</h2>
                <textarea class="textarea" id="movieInput" placeholder="Share your life story... Key moments, relationships, challenges, triumphs. Write freely - the AI will structure it into a cinematic screenplay."></textarea>
                <div class="btn-group">
                    <button class="btn btn-action" id="generateMovieBtn">Create Script</button>
                </div>
                <div class="loading" id="movieLoading">
                    <div class="spinner"></div>
                    <div class="loading-text">Writing your screenplay...</div>
                </div>
                <div class="output" id="movieOutput"></div>
                <div class="btn-group" id="movieActions" style="display: none;">
                    <button class="btn btn-secondary" id="shareMovie">Share</button>
                    <button class="btn btn-secondary" id="exportMovie">Download PDF</button>
                </div>
            </div>
        </div>

        <!-- Insights View -->
        <div class="view" id="insightsView">
            <div class="card">
                <h2 class="card-title">Birth Day Significance</h2>
                <button class="btn btn-action" id="generateInsightsBtn">Discover Significance</button>
                <div class="loading" id="insightsLoading">
                    <div class="spinner"></div>
                    <div class="loading-text">Analyzing your birth date...</div>
                </div>
                <div class="output" id="insightsOutput"></div>
            </div>
        </div>

        <!-- Profile View -->
        <div class="view" id="profileView">
            <div class="profile-header">
                <div class="avatar-container">
                    <div class="avatar" id="avatar">
                        <span id="avatarInitial">K</span>
                    </div>
                    <label class="avatar-upload-btn">
                        üì∑
                        <input type="file" accept="image/*" id="avatarUpload">
                    </label>
                </div>
                <div class="profile-name" id="profileName">User</div>
                <div class="profile-age" id="profileAge">Age: 0</div>
                <div class="level-badge" id="levelBadge">Level 1</div>
            </div>

            <div class="card">
                <div class="exp-container">
                    <div class="exp-bar">
                        <div class="exp-progress" id="expProgress"></div>
                    </div>
                    <div class="exp-text" id="expText">0 / 100 EXP</div>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">Achievements</h3>
                <div class="achievement-grid" id="achievementGrid"></div>
            </div>

            <div class="card">
                <h3 class="card-title">Statistics</h3>
                <div class="widget-grid">
                    <div class="widget">
                        <div class="widget-value" id="daysActive">0</div>
                        <div class="widget-label">Days Active</div>
                    </div>
                    <div class="widget">
                        <div class="widget-value" id="scriptsCount">0</div>
                        <div class="widget-label">Scripts</div>
                    </div>
                </div>
            </div>

            <!-- Your Files Section -->
            <div class="card files-section">
                <h3 class="card-title">üìÅ Your Files</h3>
                <div id="filesList">
                    <div style="text-align: center; color: var(--text-tertiary); padding: 2rem;">
                        No files yet. Create your first story!
                    </div>
                </div>
            </div>
        </div>

        <!-- Professional Dock -->
        <nav class="dock">
            <div class="dock-items">
                <div class="dock-item active" data-view="home">
                    <div class="dock-icon">‚è±Ô∏è</div>
                    <div class="dock-label">Home</div>
                </div>
                <div class="dock-item" data-view="future">
                    <div class="dock-icon">üîÆ</div>
                    <div class="dock-label">Future</div>
                </div>
                <div class="dock-item" data-view="movie">
                    <div class="dock-icon">üé¨</div>
                    <div class="dock-label">Movie</div>
                </div>
                <div class="dock-item" data-view="insights">
                    <div class="dock-icon">‚ú®</div>
                    <div class="dock-label">Insights</div>
                </div>
                <div class="dock-item" data-view="profile">
                    <div class="dock-icon">üë§</div>
                    <div class="dock-label">Profile</div>
                </div>
            </div>
        </nav>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modal">
        <div class="modal">
            <h3 class="modal-title" id="modalTitle">Title</h3>
            <p class="modal-message" id="modalMessage">Message</p>
            <button class="modal-btn" id="modalClose">Close</button>
        </div>
    </div>

    <script>
        // Gemini API Config
        const GEMINI_KEY = 'AIzaSyCcEL5N_MulMqgLEngbKAc1hcdiC0pAlXY';
        const GEMINI_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent';

        // User Data
        let user = {
            name: '',
            dob: null,
            location: '',
            lifeExpectancy: 80,
            exp: 0,
            level: 1,
            achievements: [],
            scripts: 0,
            firstVisit: null,
            avatar: null,
            dobDay: null,
            dobMonth: null,
            dobYear: null,
            files: [] // Store generated files
        };

        // App State
        let counterInterval = null;
        let currentGeneratedContent = { future: '', movie: '', insights: '' };

        // Initialize
        function init() {
            loadData();
            createParticles();
            setupOnboarding();
            setupSlider();
            setupNavigation();
            setupEventListeners();

            if (user.name && user.dob) {
                hideOnboarding();
                startCounter();
                updateProfile();
            }
        }

        // Create Particles
        function createParticles() {
            const container = document.getElementById('particles');
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = `${Math.random() * 100}%`;
                particle.style.animationDelay = `${Math.random() * 8}s`;
                particle.style.animationDuration = `${5 + Math.random() * 10}s`;
                container.appendChild(particle);
            }
        }

        // Setup Onboarding
        function setupOnboarding() {
            // Days
            const dayDropdown = document.getElementById('dayDropdown');
            for (let i = 1; i <= 31; i++) {
                const opt = document.createElement('div');
                opt.className = 'date-option';
                opt.textContent = i;
                opt.onclick = () => selectDay(i);
                dayDropdown.appendChild(opt);
            }

            // Months
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const monthDropdown = document.getElementById('monthDropdown');
            months.forEach((month, idx) => {
                const opt = document.createElement('div');
                opt.className = 'date-option';
                opt.textContent = month;
                opt.onclick = () => selectMonth(idx, month);
                monthDropdown.appendChild(opt);
            });

            // Years
            const yearDropdown = document.getElementById('yearDropdown');
            const currentYear = new Date().getFullYear();
            for (let i = currentYear; i >= currentYear - 120; i--) {
                const opt = document.createElement('div');
                opt.className = 'date-option';
                opt.textContent = i;
                opt.onclick = () => selectYear(i);
                yearDropdown.appendChild(opt);
            }

            // Toggles
            document.getElementById('dayBtn').onclick = (e) => {
                e.preventDefault();
                toggleDropdown('day');
            };
            document.getElementById('monthBtn').onclick = (e) => {
                e.preventDefault();
                toggleDropdown('month');
            };
            document.getElementById('yearBtn').onclick = (e) => {
                e.preventDefault();
                toggleDropdown('year');
            };

            // Close on outside click
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.date-selector')) {
                    closeAllDropdowns();
                }
            });
        }

        function toggleDropdown(type) {
            const dropdown = document.getElementById(`${type}Dropdown`);
            const isOpen = dropdown.classList.contains('show');
            closeAllDropdowns();
            if (!isOpen) {
                dropdown.classList.add('show');
                document.getElementById(`${type}Btn`).classList.add('active');
            }
        }

        function closeAllDropdowns() {
            ['day', 'month', 'year'].forEach(type => {
                document.getElementById(`${type}Dropdown`).classList.remove('show');
                document.getElementById(`${type}Btn`).classList.remove('active');
            });
        }

        function selectDay(day) {
            user.dobDay = day;
            document.getElementById('dayBtn').textContent = day;
            closeAllDropdowns();
        }

        function selectMonth(idx, name) {
            user.dobMonth = idx;
            document.getElementById('monthBtn').textContent = name;
            closeAllDropdowns();
        }

        function selectYear(year) {
            user.dobYear = year;
            document.getElementById('yearBtn').textContent = year;
            closeAllDropdowns();
        }

        // Setup Slider
        function setupSlider() {
            const slider = document.getElementById('lifeSlider');
            const fill = document.getElementById('sliderFill');
            const thumb = document.getElementById('sliderThumb');
            const value = document.getElementById('sliderValue');

            function updateSlider() {
                const percent = ((slider.value - 1) / 119) * 100;
                fill.style.width = `${percent}%`;
                thumb.style.left = `${percent}%`;
                value.textContent = `${slider.value} YEARS`;
            }

            slider.oninput = updateSlider;
            updateSlider();
        }

        // Handle Onboarding Submit
        document.getElementById('onboardingForm').onsubmit = (e) => {
            e.preventDefault();
            
            const name = document.getElementById('nameInput').value.trim();
            const location = document.getElementById('locationInput').value.trim();
            const expectancy = parseInt(document.getElementById('lifeSlider').value);

            if (!name || user.dobDay === null || user.dobMonth === null || user.dobYear === null || !location) {
                showModal('Missing Information', 'Please fill in all fields to continue your journey.');
                return;
            }

            user.name = name;
            user.location = location;
            user.lifeExpectancy = expectancy;
            user.dob = new Date(user.dobYear, user.dobMonth, user.dobDay);
            user.firstVisit = user.firstVisit || new Date();

            saveData();
            hideOnboarding();
            startCounter();
            updateProfile();
            addExp(10);
            unlockAchievement('first_visit');
        };

        function hideOnboarding() {
            document.getElementById('onboarding').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
        }

        // Navigation
        function setupNavigation() {
            document.querySelectorAll('.dock-item').forEach(item => {
                item.onclick = () => {
                    const viewName = item.dataset.view;
                    
                    document.querySelectorAll('.dock-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    
                    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                    document.getElementById(`${viewName}View`).classList.add('active');
                };
            });
        }

        // Life Counter
        function startCounter() {
            if (counterInterval) clearInterval(counterInterval);
            updateStats();
            counterInterval = setInterval(updateStats, 1000);
        }

        // Calculate Full Moons since birth
        function calculateFullMoons(birthDate) {
            const now = new Date();
            const daysSinceBirth = Math.floor((now - birthDate) / (1000 * 60 * 60 * 24));
            const fullMoons = Math.floor(daysSinceBirth / 29.53);
            return fullMoons;
        }

        function updateStats() {
            if (!user.dob) return;

            const now = new Date();
            const birth = new Date(user.dob);
            const endLife = new Date(birth);
            endLife.setFullYear(endLife.getFullYear() + user.lifeExpectancy);

            // Seconds remaining
            const remainingMs = endLife - now;
            const remainingSec = Math.max(0, Math.floor(remainingMs / 1000));
            document.getElementById('secondsCounter').textContent = remainingSec.toLocaleString();

            // Stats
            const elapsedMs = now - birth;
            const weeks = Math.floor(elapsedMs / (7 * 24 * 60 * 60 * 1000));
            const fullMoons = calculateFullMoons(birth);
            const newYears = calculateAge(birth); // Use correct age calculation

            // Age - Use correct calculation
            const years = calculateAge(birth);
            const totalMonths = (now.getFullYear() - birth.getFullYear()) * 12 + (now.getMonth() - birth.getMonth());
            const displayMonths = totalMonths % 12;

            document.getElementById('weeksLived').textContent = weeks.toLocaleString();
            document.getElementById('fullMoons').textContent = fullMoons.toLocaleString();
            document.getElementById('newYears').textContent = newYears;
            document.getElementById('ageDisplay').textContent = `${years}y ${displayMonths}m`;
        }

        // Event Listeners
        function setupEventListeners() {
            document.getElementById('generateFutureBtn').onclick = generateFuture;
            document.getElementById('generateMovieBtn').onclick = generateMovie;
            document.getElementById('generateInsightsBtn').onclick = generateInsights;
            document.getElementById('shareFuture').onclick = () => shareContent('future');
            document.getElementById('shareMovie').onclick = () => shareContent('movie');
            document.getElementById('exportFuture').onclick = () => exportToPDF('future');
            document.getElementById('exportMovie').onclick = () => exportToPDF('movie');
            document.getElementById('avatarUpload').onchange = handleAvatar;
            document.getElementById('modalClose').onclick = hideModal;
        }

        // Gemini API Call
        async function callGemini(prompt) {
            try {
                const res = await fetch(`${GEMINI_URL}?key=${GEMINI_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: {
                            temperature: 0.9,
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 8192,
                        }
                    })
                });

                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.error?.message || 'API request failed');
                }

                const data = await res.json();
                
                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                    throw new Error('Invalid response from AI');
                }

                return data.candidates[0].content.parts[0].text;
            } catch (err) {
                console.error('Gemini API Error:', err);
                throw new Error('Failed to generate content. Please check your internet connection and try again.');
            }
        }

        // Calculate Age Correctly
        function calculateAge(birthDate) {
            const today = new Date();
            const birth = new Date(birthDate);
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            
            // If birthday hasn't occurred this year yet, subtract 1
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            
            return age;
        }

        // Enhanced typewriter with bubble wrapper and key moment detection
        function typewriterEffect(element, text, speed = 15) {
            return new Promise((resolve) => {
                // Wrap content in bubble
                const bubble = document.createElement('div');
                bubble.className = 'ai-response-bubble';
                element.innerHTML = '';
                element.appendChild(bubble);
                
                let index = 0;
                
                const interval = setInterval(() => {
                    if (index < text.length) {
                        if (text[index] === '<') {
                            const closeTag = text.indexOf('>', index);
                            if (closeTag !== -1) {
                                bubble.innerHTML += text.substring(index, closeTag + 1);
                                index = closeTag + 1;
                            } else {
                                bubble.innerHTML += text[index];
                                index++;
                            }
                        } else {
                            bubble.innerHTML += text[index];
                            index++;
                        }
                        
                        // Auto-scroll
                        element.scrollTop = element.scrollHeight;
                    } else {
                        clearInterval(interval);
                        
                        // Highlight key moments after generation
                        highlightKeyMoments(bubble);
                        resolve();
                    }
                }, speed);
            });
        }

        // Highlight key moments in the generated content
        function highlightKeyMoments(container) {
            const paragraphs = container.querySelectorAll('p');
            const keyPhrases = [
                'milestone', 'achievement', 'breakthrough', 'success', 'turned point',
                'major', 'significant', 'crucial', 'pivotal', 'transformed', 'established',
                'launched', 'founded', 'discovered', 'realized', 'accomplished'
            ];
            
            paragraphs.forEach(p => {
                const text = p.textContent.toLowerCase();
                const hasKeyPhrase = keyPhrases.some(phrase => text.includes(phrase));
                
                if (hasKeyPhrase && p.textContent.length > 50) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'key-moment';
                    wrapper.innerHTML = p.innerHTML;
                    p.parentNode.replaceChild(wrapper, p);
                }
            });
        }

        // Generate Future - CREATE PDF
        async function generateFuture() {
            const input = document.getElementById('futureInput').value.trim();
            if (!input) {
                showModal('No Input', 'Please describe your future vision first.');
                return;
            }

            const loading = document.getElementById('futureLoading');
            loading.classList.add('show');

            const age = calculateAge(user.dob);

            const prompt = `You are a visionary life coach. Create a deeply personalized future life story for ${user.name}.

CONTEXT:
- Name: ${user.name}
- Current Age: ${age}
- Location: ${user.location}
- Their Vision: ${input}

Create a unique, inspiring future narrative that:
1. Uses ${user.name}'s specific vision above
2. Projects 5, 10, and 20 years ahead
3. Describes career, relationships, achievements, lifestyle
4. Addresses their specific goals
5. Shows realistic challenges and growth
6. Feels personalized to ${user.name}

Write ONLY the story content in plain text. NO HTML tags, NO special characters like ** or *, NO formatting marks.
Just clean, readable prose. Keep it between 300-400 words.`;

            try {
                const result = await callGemini(prompt);
                
                // Clean the text
                let cleanText = result.replace(/<[^>]*>/g, '');
                cleanText = cleanText.replace(/\*\*/g, '');
                cleanText = cleanText.replace(/\*/g, '');
                cleanText = cleanText.trim();
                
                // Generate and download PDF
                await generatePDF('future', cleanText, user.name);
                
                user.scripts++;
                addExp(50);
                saveData();
                unlockAchievement('future_written');
                
                if (user.scripts >= 5) unlockAchievement('prolific');
            } catch (err) {
                showModal('Error', err.message);
            } finally {
                loading.classList.remove('show');
            }
        }

        // Generate Movie - CREATE PDF
        async function generateMovie() {
            const input = document.getElementById('movieInput').value.trim();
            if (!input) {
                showModal('No Input', 'Please share your life story first.');
                return;
            }

            const loading = document.getElementById('movieLoading');
            loading.classList.add('show');

            const age = calculateAge(user.dob);

            const prompt = `You are a professional screenwriter. Create a cinematic screenplay based on ${user.name}'s life.

STORY:
- Name: ${user.name}
- Age: ${age}
- Location: ${user.location}
- Their Story: ${input}

Create a complete movie script that:
1. Uses ${user.name}'s specific story above
2. Three-act structure
3. Scene headings (INT/EXT, LOCATION, TIME)
4. Character development and dialogue
5. Emotional beats
6. Feels authentic to their story

Write ONLY the screenplay content in plain text with proper screenplay formatting. NO HTML tags, NO special characters like ** or *, NO formatting marks.
Just clean, readable screenplay text. Keep it between 300-400 words.`;

            try {
                const result = await callGemini(prompt);
                
                // Clean the text
                let cleanText = result.replace(/<[^>]*>/g, '');
                cleanText = cleanText.replace(/\*\*/g, '');
                cleanText = cleanText.replace(/\*/g, '');
                cleanText = cleanText.trim();
                
                // Generate and download PDF
                await generatePDF('movie', cleanText, user.name);
                
                user.scripts++;
                addExp(75);
                saveData();
                unlockAchievement('movie_written');
                
                if (user.scripts >= 10) unlockAchievement('master');
            } catch (err) {
                showModal('Error', err.message);
            } finally {
                loading.classList.remove('show');
            }
        }

        // Generate Insights - CREATE PDF
        async function generateInsights() {
            const loading = document.getElementById('insightsLoading');
            loading.classList.add('show');

            const birth = new Date(user.dob);
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            const date = `${months[birth.getMonth()]} ${birth.getDate()}, ${birth.getFullYear()}`;

            const prompt = `You are a historian. Analyze the significance of ${date} - ${user.name}'s birth date.

Provide a comprehensive analysis with:
1. Major historical events on this exact date
2. Notable people born this day throughout history
3. Important inventions/discoveries announced on this date
4. Cultural significance of ${birth.getFullYear()}
5. An inspiring reflection for ${user.name}

Write ONLY the content in plain text. NO HTML tags, NO special characters like ** or *, NO formatting marks.
Just clean, readable prose organized with clear sections. Keep it between 250-350 words.`;

            try {
                const result = await callGemini(prompt);
                
                // Clean the text
                let cleanText = result.replace(/<[^>]*>/g, '');
                cleanText = cleanText.replace(/\*\*/g, '');
                cleanText = cleanText.replace(/\*/g, '');
                cleanText = cleanText.trim();
                
                // Generate and download PDF
                await generatePDF('insights', cleanText, user.name);
                
                addExp(25);
                saveData();
                unlockAchievement('insights');
            } catch (err) {
                showModal('Error', err.message);
            } finally {
                loading.classList.remove('show');
            }
        }

        // PDF Generation with file storage
        async function generatePDF(type, content, userName) {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // PDF Configuration
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 20;
                const maxWidth = pageWidth - (margin * 2);
                
                // Generate smart filename
                let filename;
                let title;
                if (type === 'future') {
                    filename = `${userName.replace(/\s+/g, '_')}_Future_Vision.pdf`;
                    title = 'My Future Story';
                } else if (type === 'movie') {
                    filename = `${userName.replace(/\s+/g, '_')}_Life_Story.pdf`;
                    title = 'My Life Movie Script';
                } else if (type === 'insights') {
                    filename = `${userName.replace(/\s+/g, '_')}_Birthday_Significance.pdf`;
                    title = 'My Birthday Significance';
                }
                
                // Title
                doc.setFontSize(20);
                doc.setFont(undefined, 'bold');
                doc.text(title, margin, margin);
                
                // Subtitle
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text(`Created for ${userName}`, margin, margin + 10);
                doc.text(new Date().toLocaleDateString(), margin, margin + 16);
                
                // Content
                doc.setFontSize(11);
                const lines = doc.splitTextToSize(content, maxWidth);
                let y = margin + 30;
                
                lines.forEach(line => {
                    if (y > pageHeight - margin) {
                        doc.addPage();
                        y = margin;
                    }
                    doc.text(line, margin, y);
                    y += 7;
                });
                
                // Save PDF
                doc.save(filename);
                
                // Store file info
                const fileInfo = {
                    name: filename,
                    type: type,
                    date: new Date().toISOString(),
                    content: content
                };
                
                user.files.push(fileInfo);
                saveData();
                updateFilesList();
                
                let successMsg;
                if (type === 'future') {
                    successMsg = 'Your future story has been created and downloaded as a PDF!';
                } else if (type === 'movie') {
                    successMsg = 'Your movie script has been created and downloaded as a PDF!';
                } else if (type === 'insights') {
                    successMsg = 'Your birthday significance has been created and downloaded as a PDF!';
                }
                
                showModal('Success!', successMsg);
                
            } catch (err) {
                console.error('PDF Generation Error:', err);
                showModal('Error', 'Failed to generate PDF. Please try again.');
            }
        }

        // Update Files List in Profile
        function updateFilesList() {
            const filesList = document.getElementById('filesList');
            
            if (!user.files || user.files.length === 0) {
                filesList.innerHTML = `
                    <div style="text-align: center; color: var(--text-tertiary); padding: 2rem;">
                        No files yet. Create your first story!
                    </div>
                `;
                return;
            }
            
            filesList.innerHTML = '';
            
            user.files.slice().reverse().forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                
                const date = new Date(file.date);
                const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                fileItem.innerHTML = `
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-date">${formattedDate}</div>
                    </div>
                    <div class="file-actions">
                        <button class="file-btn" onclick="downloadFile(${user.files.length - 1 - index})">Download</button>
                        <button class="file-btn" onclick="shareFile(${user.files.length - 1 - index})">Share</button>
                    </div>
                `;
                
                filesList.appendChild(fileItem);
            });
        }

        // Download File
        function downloadFile(index) {
            const file = user.files[index];
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 20;
            const maxWidth = pageWidth - (margin * 2);
            
            // Title
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            let title;
            if (file.type === 'future') {
                title = 'My Future Story';
            } else if (file.type === 'movie') {
                title = 'My Life Movie Script';
            } else if (file.type === 'insights') {
                title = 'My Birthday Significance';
            }
            doc.text(title, margin, margin);
            
            // Subtitle
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(`Created for ${user.name}`, margin, margin + 10);
            doc.text(new Date(file.date).toLocaleDateString(), margin, margin + 16);
            
            // Content
            doc.setFontSize(11);
            const lines = doc.splitTextToSize(file.content, maxWidth);
            let y = margin + 30;
            
            lines.forEach(line => {
                if (y > pageHeight - margin) {
                    doc.addPage();
                    y = margin;
                }
                doc.text(line, margin, y);
                y += 7;
            });
            
            doc.save(file.name);
            showModal('Downloaded', 'File downloaded successfully!');
        }

        // Share File
        async function shareFile(index) {
            const file = user.files[index];
            
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: file.name,
                        text: file.content
                    });
                } catch (e) {
                    // User cancelled share
                }
            } else {
                try {
                    await navigator.clipboard.writeText(file.content);
                    showModal('Copied', 'Content copied to clipboard!');
                } catch (e) {
                    showModal('Error', 'Could not copy content.');
                }
            }
        }

        // Export to PDF using jsPDF (OLD FUNCTION - REMOVE IF PRESENT)
        async function exportToPDF(type) {
            showModal('Info', 'PDFs are now automatically generated and downloaded!');
        }

        // Share Content (OLD FUNCTION - REMOVE IF PRESENT)
        async function shareContent(type) {
            showModal('Info', 'Files can be shared from Your Files section in Profile!');
        }

        // Avatar Upload
        function handleAvatar(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                user.avatar = event.target.result;
                saveData();
                updateProfile();
            };
            reader.readAsDataURL(file);
        }

        // Profile
        function updateProfile() {
            document.getElementById('profileName').textContent = user.name;
            document.getElementById('avatarInitial').textContent = user.name.charAt(0).toUpperCase();
            
            const age = calculateAge(user.dob);
            document.getElementById('profileAge').textContent = `Age: ${age}`;

            const level = Math.floor(user.exp / 100) + 1;
            const exp = user.exp % 100;
            user.level = level;

            document.getElementById('levelBadge').textContent = `Level ${level}`;
            document.getElementById('expProgress').style.width = `${exp}%`;
            document.getElementById('expText').textContent = `${exp} / 100 EXP`;

            if (user.firstVisit) {
                const days = Math.floor((new Date() - new Date(user.firstVisit)) / (1000 * 60 * 60 * 24)) + 1;
                document.getElementById('daysActive').textContent = days;
            }
            
            document.getElementById('scriptsCount').textContent = user.scripts;

            if (user.avatar) {
                const avatar = document.getElementById('avatar');
                avatar.style.backgroundImage = `url(${user.avatar})`;
                avatar.style.backgroundSize = 'cover';
                avatar.querySelector('span').style.display = 'none';
            }

            renderAchievements();
            updateFilesList();
        }

        // EXP System
        function addExp(amount) {
            user.exp += amount;
            saveData();
            updateProfile();
            
            if (user.level >= 5) unlockAchievement('level_5');
            if (user.level >= 10) unlockAchievement('level_10');
            if (user.level >= 20) unlockAchievement('level_20');
        }

        // Achievements
        const achievements = [
            { id: 'first_visit', name: 'First Step', icon: '‚ú®' },
            { id: 'future_written', name: 'Visionary', icon: 'üîÆ' },
            { id: 'movie_written', name: 'Director', icon: 'üé¨' },
            { id: 'insights', name: 'Historian', icon: 'üìö' },
            { id: 'level_5', name: 'Rising Star', icon: '‚≠ê' },
            { id: 'level_10', name: 'Champion', icon: 'üèÜ' },
            { id: 'level_20', name: 'Legend', icon: 'üëë' },
            { id: 'prolific', name: 'Prolific', icon: '‚úçÔ∏è' },
            { id: 'master', name: 'Master', icon: 'üé≠' }
        ];

        function unlockAchievement(id) {
            if (!user.achievements.includes(id)) {
                user.achievements.push(id);
                saveData();
                updateProfile();
                
                const ach = achievements.find(a => a.id === id);
                if (ach) {
                    showModal('Achievement Unlocked!', `${ach.icon} ${ach.name}`);
                }
            }
        }

        function renderAchievements() {
            const grid = document.getElementById('achievementGrid');
            grid.innerHTML = '';

            achievements.forEach(ach => {
                const unlocked = user.achievements.includes(ach.id);
                const div = document.createElement('div');
                div.className = `achievement ${unlocked ? 'unlocked' : ''}`;
                div.innerHTML = `
                    <div class="achievement-icon">${unlocked ? ach.icon : 'üîí'}</div>
                    <div class="achievement-name">${ach.name}</div>
                `;
                grid.appendChild(div);
            });
        }

        // Storage
        function saveData() {
            localStorage.setItem('katzLifeData', JSON.stringify(user));
        }

        function loadData() {
            const saved = localStorage.getItem('katzLifeData');
            if (saved) {
                user = JSON.parse(saved);
                if (user.dob) user.dob = new Date(user.dob);
                if (user.firstVisit) user.firstVisit = new Date(user.firstVisit);
                if (!user.files) user.files = []; // Ensure files array exists
            }
        }

        // Modal
        function showModal(title, msg) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = msg;
            document.getElementById('modal').classList.add('show');
        }

        function hideModal() {
            document.getElementById('modal').classList.remove('show');
        }

        // Start
        init();
    </script>
</body>
</html>
